# /etc/ufw/before.rules

# Start of the NAT table configuration for port forwarding
*nat
:PREROUTING ACCEPT [0:0]
# Forward traffic from port 8080 to port 80
-A PREROUTING -p tcp --dport 8080 -j REDIRECT --to-port 80
# End of the NAT table configuration
COMMIT

# Start of the filter table configuration
*filter
:ufw-before-input - [0:0]
:ufw-before-output - [0:0]
:ufw-before-forward - [0:0]

# Allow all traffic on the loopback interface
-A ufw-before-input -i lo -j ACCEPT
-A ufw-before-output -o lo -j ACCEPT

# Quickly process packets for established connections
-A ufw-before-input -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A ufw-before-output -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
-A ufw-before-forward -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT

# Drop packets with invalid connection states
-A ufw-before-input -m conntrack --ctstate INVALID -j DROP

# Accept ICMP packets for INPUT and FORWARD
-A ufw-before-input -p icmp -j ACCEPT
-A ufw-before-forward -p icmp -j ACCEPT

# Allow DHCP client traffic to function
-A ufw-before-input -p udp --sport 67 --dport 68 -j ACCEPT

# End of the filter table configuration
COMMIT
